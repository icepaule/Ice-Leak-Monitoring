{% extends "base.html" %}
{% block title %}Einstellungen - Ice-Leak-Monitor{% endblock %}

{% block content %}
<h1>Einstellungen</h1>

<!-- OSINT Module -->
<div class="card settings-card">
    <h2>OSINT Module</h2>
    <p class="settings-desc">Aktiviere/deaktiviere OSINT-Module fuer die automatische Aufklaerung. Aktivierte Module werden in Stage 1 jedes Scans ausgefuehrt.</p>

    <div class="module-list">
        {% for mod in modules %}
        <div class="module-row" id="module-{{ mod.module_key }}">
            <div class="module-toggle">
                <label class="toggle-switch">
                    <input type="checkbox"
                           {% if mod.is_enabled %}checked{% endif %}
                           onchange="toggleModule('{{ mod.module_key }}')">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="module-info">
                <span class="module-name">{{ mod.display_name }}</span>
                <span class="module-desc">{{ mod.description }}</span>
            </div>
            {% if mod.needs_api_key %}
            <div class="module-config">
                <div class="api-key-field">
                    <input type="password"
                           class="input input-sm"
                           id="apikey-{{ mod.module_key }}"
                           placeholder="API Key"
                           value="{{ mod.api_key_masked }}"
                           onfocus="this.value=''; this.type='text'"
                           onblur="if(!this.value) { this.value='{{ mod.api_key_masked }}'; this.type='password'; }">
                    <button class="btn btn-sm btn-primary"
                            onclick="saveModuleConfig('{{ mod.module_key }}')">
                        Speichern
                    </button>
                </div>
                {% if mod.has_api_key %}
                <span class="api-key-status api-key-ok">Key konfiguriert</span>
                {% else %}
                <span class="api-key-status api-key-missing">Kein Key</span>
                {% endif %}
            </div>
            {% endif %}
            <div class="module-status">
                {% if mod.is_enabled %}
                <span class="badge badge-completed">Aktiv</span>
                {% else %}
                <span class="badge badge-skipped">Inaktiv</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- E-Mail-Empfaenger -->
<div class="card settings-card">
    <h2>E-Mail-Empfaenger</h2>
    <p class="settings-desc">Empfaenger fuer Scan-Berichte und Finding-Reports (kommagetrennt).</p>
    <div style="display:flex; gap:0.5rem; align-items:center;">
        <input type="text" id="email-recipients" class="input" style="flex:1; font-family:monospace; font-size:0.85rem; background:#2d333b; color:#cdd9e5; border:1px solid #444c56; border-radius:4px; padding:0.5rem 0.75rem;" value="{{ email_recipients }}" placeholder="ciso@example.com, it-sec@example.com">
        <button class="btn btn-primary" onclick="saveEmailRecipients()">Speichern</button>
    </div>
</div>

<!-- AI Prompt Editor -->
<div class="card settings-card">
    <h2>AI-Bewertungsprompt</h2>
    <p class="settings-desc">Prompt fuer die CISO-Bewertung von Findings. Wird beim naechsten Scan oder Reassessment verwendet.</p>
    <textarea id="finding-prompt" rows="25" style="width:100%; font-family:monospace; font-size:0.85rem; background:#2d333b; color:#cdd9e5; border:1px solid #444c56; border-radius:4px; padding:0.75rem; resize:vertical;">{{ finding_prompt }}</textarea>
    <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
        <button class="btn btn-primary" onclick="savePrompt()">Speichern</button>
        <button class="btn btn-secondary" onclick="resetPrompt()">Auf Standard zuruecksetzen</button>
    </div>
    <p class="settings-desc" style="margin-top:0.5rem;">Platzhalter: <code>{scanner}</code>, <code>{detector_name}</code>, <code>{file_path}</code>, <code>{repo_name}</code>, <code>{repo_description}</code>, <code>{verified}</code>, <code>{matched_snippet}</code>, <code>{keyword_context}</code></p>
</div>

<!-- OSINT Results -->
<div class="card">
    <h2>OSINT-Ergebnisse</h2>
    {% if recent_results %}
    <div class="osint-results-wrap">
        <table class="table osint-results-table">
            <thead>
                <tr>
                    <th>Modul</th>
                    <th>Keyword</th>
                    <th>Typ</th>
                    <th>Ergebnis</th>
                    <th>Datum</th>
                </tr>
            </thead>
            <tbody>
                {% for r in recent_results %}
                <tr>
                    <td><span class="badge badge-info">{{ r.module_key }}</span></td>
                    <td><code>{{ r.keyword_used }}</code></td>
                    <td><span class="badge badge-category">{{ r.result_type or '-' }}</span></td>
                    <td class="result-value">{{ r.result_value[:80] }}{% if r.result_value|length > 80 %}...{% endif %}</td>
                    <td class="text-muted">{{ r.created_at[:16] if r.created_at else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="empty-state">Noch keine OSINT-Ergebnisse. Starte einen Scan mit aktivierten OSINT-Modulen.</p>
    {% endif %}
</div>
{% endblock %}
